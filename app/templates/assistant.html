<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Peregrine CFO</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Favicon (Falcon head logo you uploaded to /app/static/) -->
    <link rel="icon" type="image/png" href="/static/peregrine-logo.png" />

    <style>
        :root {
            --bg-main: #05070A;
            --bg-panel: #05070A;
            --bg-subpanel: #0C131D;
            --border-subtle: #1E2935;
            --text-main: #f0f4f8;
            --text-muted: #8A9AB0;

            /* Matte Blue Palette */
            --accent: #1F4E73;
            --accent-dark: #163B56;
            --accent-soft: rgba(31, 78, 115, 0.35);

            --user-bubble-gradient: linear-gradient(135deg, #1F4E73, #163B56);
            --assistant-bubble: #0D1117;

            --glow-accent: 0 0 18px rgba(31, 78, 115, 0.6);
            --glow-soft: 0 0 12px rgba(31, 78, 115, 0.35);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
        }

        .app-shell {
            max-width: 1300px;
            margin: 24px auto;
            padding: 0 12px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 14px 18px;
            border: 1px solid var(--border-subtle);
            margin-bottom: 16px;
            box-shadow: 0 20px 25px -20px rgba(0,0,0,0.5);
        }

        .top-left {
            display: flex;
            flex-direction: column;
        }

        .top-title { font-size: 1.3rem; font-weight: 600; }
        .top-subtitle { font-size: .85rem; color: var(--text-muted); }

        .top-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .company-label { font-size: .80rem; color: var(--text-muted); }

        .company-select {
            padding: 8px 10px;
            background: var(--bg-subpanel);
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            color: var(--text-main);
        }

        .btn {
            padding: 8px 14px;
            font-weight: 600;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
            cursor: pointer;
            box-shadow: var(--glow-accent);
        }

        .btn:disabled { opacity:.5; cursor:not-allowed; }

        /* Grid layout */
        .content-shell {
            display:grid;
            grid-template-columns:260px 1fr;
            gap:16px;
        }

        .panel {
            background: var(--bg-panel);
            border-radius:12px;
            border:1px solid var(--border-subtle);
            box-shadow:0 20px 25px -20px rgba(0,0,0,0.5);
        }

        /* Prompts */
        .prompts-panel { padding:14px 16px; }

        .prompts-title { font-size:.95rem; font-weight:500; }
        .prompts-subtitle { font-size:.78rem; color:var(--text-muted); }

        .prompt-group { margin-top:12px; }

        .prompt-group-title {
            font-size:.75rem;
            text-transform:uppercase;
            color:var(--text-muted);
            margin-bottom:4px;
        }

        .prompt-chip {
            display:inline-block;
            background:rgba(15,23,42,.96);
            padding:7px 12px;
            margin:6px 6px 0 0;
            border-radius:999px;
            font-size:.82rem;
            cursor:pointer;
            border:none;
        }

        .prompt-chip:hover {
            background:rgba(31,78,115,.4);
            box-shadow:0 0 0 1px var(--accent-soft);
        }

        /* Chat Panel */
        .chat-panel { padding:14px 16px; display:flex; flex-direction:column; }

        .chat-title { font-size:1.1rem; font-weight:600; }
        .chat-subtitle { font-size:.80rem; color:var(--text-muted); }

        .chat-messages {
            flex:1;
            margin-top:12px;
            padding:12px;
            border-radius:10px;
            background:
                radial-gradient(circle at top left, rgba(31,78,115,.18), transparent 40%),
                radial-gradient(circle at bottom right, rgba(148,163,184,.09), transparent 40%),
                #020617;
            border:1px solid var(--border-subtle);
            overflow-y:auto;
        }

        .message {
            max-width:75%;
            padding:10px 14px;
            border-radius:18px;
            margin:10px 0;
            white-space:pre-wrap;
            line-height:1.45;
        }

        .message.user {
            margin-left:auto;
            background:var(--user-bubble-gradient);
            color:#EAF4FF;
        }

        .message.assistant {
            margin-right:auto;
            background:var(--assistant-bubble);
            border:1px solid var(--border-subtle);
        }

        /* Typing bubble */
        .message.typing {
            background:#f9fafb;
            color:#020617;
            display:flex;
            gap:6px;
            align-items:center;
        }

        .typing-dot {
            width:6px;
            height:6px;
            border-radius:50%;
            background:#020617;
            animation:typingBlink 1s infinite ease-in-out;
            opacity:.55;
        }

        .typing-dot:nth-child(2){ animation-delay:.15s; }
        .typing-dot:nth-child(3){ animation-delay:.3s; }

        @keyframes typingBlink {
            0%,60%,100% { opacity:.2; transform:translateY(0); }
            30% { opacity:.9; transform:translateY(-2px); }
        }

        .chat-input-row {
            display:flex;
            gap:10px;
            margin-top:12px;
        }

        textarea {
            flex:1;
            height:64px;
            padding:10px 12px;
            background:var(--bg-subpanel);
            color:var(--text-main);
            border-radius:10px;
            border:1px solid var(--border-subtle);
            resize:none;
        }

        .status-line { font-size:.75rem; color:var(--text-muted); margin-top:6px; }
    </style>
</head>

<body>
    <div class="app-shell">

        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="top-left">
                <div class="top-title">Peregrine CFO</div>
                <div class="top-subtitle">
                    Unified view of your QuickBooks companies. Ask questions; Peregrine reads the data and explains what’s going on.
                </div>
            </div>

            <div class="top-right">
                <span class="company-label">Company selector</span>
                <select id="companySelect" class="company-select" onchange="onCompanyChange()">
                    <option value="">Loading…</option>
                </select>
                <button id="connectBtn" class="btn" onclick="connectQuickBooks()">Connect to QuickBooks</button>
            </div>
        </div>

        <div class="content-shell">

            <!-- PROMPTS -->
            <div class="panel prompts-panel">
                <div class="prompts-title">Suggested prompts</div>
                <div class="prompts-subtitle">What do you want to dig into?</div>

                <div class="prompt-group">
                    <div class="prompt-group-title">Vendor & Spend</div>
                    <div class="prompt-chip" onclick="usePrompt('Who are my top 5 vendors by spend this month?')">Top 5 vendors this month</div>
                    <div class="prompt-chip" onclick="usePrompt('Has my vendor concentration risk increased over the last 3 months?')">Vendor concentration risk</div>
                    <div class="prompt-chip" onclick="usePrompt('Which vendors had the biggest MoM increase?')">Vendor MoM increases</div>
                </div>

                <div class="prompt-group">
                    <div class="prompt-group-title">Customers & Revenue</div>
                    <div class="prompt-chip" onclick="usePrompt('Who are my most profitable customers?')">Top profitable customers</div>
                    <div class="prompt-chip" onclick="usePrompt('Which customers drove most revenue last quarter?')">Revenue concentration</div>
                </div>

                <div class="prompt-group">
                    <div class="prompt-group-title">Margins & COGS</div>
                    <div class="prompt-chip" onclick="usePrompt('Where have margins eroded recently?')">Margin erosion</div>
                    <div class="prompt-chip" onclick="usePrompt('Any anomalies in COGS last 6 months?')">COGS anomalies</div>
                </div>

                <div class="prompt-group">
                    <div class="prompt-group-title">Cash Flow & AR</div>
                    <div class="prompt-chip" onclick="usePrompt('Summarize cash flow trends and risks.')">Cash flow trend</div>
                    <div class="prompt-chip" onclick="usePrompt('Give me my AR aging breakdown.')">AR aging</div>
                </div>

                <div class="prompt-group">
                    <div class="prompt-group-title">Red Flags</div>
                    <div class="prompt-chip" onclick="usePrompt('Any unusual or suspicious transactions?')">Unusual transactions</div>
                    <div class="prompt-chip" onclick="usePrompt('Top 3 issues I should focus on?')">Top 3 issues</div>
                </div>
            </div>

            <!-- CHAT PANE -->
            <div class="panel chat-panel">
                <div class="chat-header">
                    <div class="chat-title">Conversation</div>
                    <div id="companyStatus" class="chat-subtitle">No company selected.</div>
                </div>

                <div id="messages" class="chat-messages"></div>

                <div class="chat-input-row">
                    <textarea id="questionInput" placeholder="Ask Peregrine CFO anything…"></textarea>
                    <button class="btn" id="askButton" onclick="sendQuestion()">Ask</button>
                </div>

                <div id="assistantStatus" class="status-line"></div>
            </div>
        </div>
    </div>


    <script>
        let currentRealmId = null;
        let typingBubble = null;

        async function loadCompanies() {
            try {
                const res = await fetch("/companies");
                const data = await res.json();

                const select = document.getElementById("companySelect");
                const connectBtn = document.getElementById("connectBtn");
                const status = document.getElementById("companyStatus");

                select.innerHTML = "";

                if (!data.length) {
                    select.innerHTML = "<option>No companies connected</option>";
                    connectBtn.textContent = "Connect to QuickBooks";
                    connectBtn.disabled = false;
                    status.textContent = "No company selected.";
                    return;
                }

                data.forEach((c, i) => {
                    const opt = document.createElement("option");
                    opt.value = c.realm_id;
                    opt.textContent = c.name;
                    if (i === 0) {
                        currentRealmId = c.realm_id;
                        opt.selected = true;
                        status.textContent = `Active company: ${c.name}`;
                    }
                    select.appendChild(opt);
                });

                connectBtn.textContent = "✓ Connected to QuickBooks";
                connectBtn.disabled = true;

            } catch (err) {
                console.error(err);
            }
        }

        function connectQuickBooks() {
            window.location.href = "/qbo/authorize";
        }

        function onCompanyChange() {
            const select = document.getElementById("companySelect");
            currentRealmId = select.value;
            const name = select.options[select.selectedIndex].text;
            document.getElementById("companyStatus").textContent = `Active company: ${name}`;
        }

        function appendMessage(role, text) {
            const messages = document.getElementById("messages");
            const div = document.createElement("div");
            div.className = `message ${role}`;
            div.textContent = text;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function usePrompt(text) {
            document.getElementById("questionInput").value = text;
        }

        function showTypingBubble() {
            const messages = document.getElementById("messages");
            typingBubble = document.createElement("div");
            typingBubble.className = "message assistant typing";
            typingBubble.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            messages.appendChild(typingBubble);
            messages.scrollTop = messages.scrollHeight;
        }

        function removeTypingBubble() {
            if (typingBubble) typingBubble.remove();
            typingBubble = null;
        }

        async function sendQuestion() {
            const input = document.getElementById("questionInput");
            const question = input.value.trim();
            if (!question) return;

            appendMessage("user", question);
            input.value = "";

            showTypingBubble();

            const askButton = document.getElementById("askButton");
            askButton.disabled = true;
            askButton.textContent = "Thinking…";

            try {
                const res = await fetch("/assistant/query", {
                    method: "POST",
                    headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({
                        realm_id: currentRealmId,
                        question
                    })
                });

                removeTypingBubble();

                const data = await res.json();
                appendMessage("assistant", data.answer || JSON.stringify(data, null, 2));

            } catch (err) {
                removeTypingBubble();
                appendMessage("assistant", "Error contacting Peregrine CFO.");
                console.error(err);
            }

            askButton.disabled = false;
            askButton.textContent = "Ask";
        }

        window.onload = loadCompanies;
    </script>

</body>
</html>
